#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å¢å¼ºç‰ˆå›¾åƒåˆ†ææç¤ºè¯ï¼ˆåŒè¾“å‡ºï¼šUI å±•ç¤º + ç”Ÿæˆæ¨¡å‹ç®€ç‰ˆæç¤ºï¼‰
"""

import re

ENHANCED_PROMPT = """
ä½ æ˜¯ä¸€åä¸–ç•Œçº§èµ„æ·±ä¿®å›¾å¸ˆå’Œä¸“ä¸šæ‘„å½±å¸ˆï¼Œå…·å¤‡è®¡ç®—æœºè§†è§‰åˆ†æèƒ½åŠ›ã€‚è¯·å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š

1. **å›¾åƒåˆ†æä¸ä¿®å›¾å»ºè®® (UI Display)**:
   - åˆ†æå›¾åƒå†…å®¹ã€è´¨é‡ã€å…‰å½±ã€æ„å›¾ç­‰ã€‚
   - æä¾›ä¸“ä¸šçš„ä¿®å›¾å»ºè®®å’Œæ»¤é•œæ¨èã€‚
   - è¾“å‡ºä¸º `ui_analysis` å¯¹è±¡ã€‚

2. **ç”Ÿæˆ/ç¼–è¾‘æç¤ºè¯ç¼–å†™ (Prompt Generation)**:
   - åŸºäºåˆ†æï¼Œç¼–å†™é’ˆå¯¹ Nano Banana Pro ä¼˜åŒ–çš„æç¤ºè¯ã€‚
   - è¾“å‡ºä¸º `gen_prompt` å¯¹è±¡ã€‚

**é€šç”¨è¦æ±‚**:
- ä»…è¾“å‡º UTF-8ã€å¯è¢« json.loads ç›´æ¥è§£æçš„ JSONã€‚
- ç¦æ­¢ä½¿ç”¨ Markdown ä»£ç å— (```)ï¼Œç¦æ­¢ä»»ä½•é¢å¤–è¯´æ˜æ–‡å­—ã€‚
- è‹¥æ— æ³•åˆ¤æ–­æŸå­—æ®µï¼Œç”¨ç©ºå­—ç¬¦ä¸² "" æˆ– nullï¼Œä¸è¦è‡ªé€ é”®ã€‚
- problem/solution/summary_ui â‰¤ 200 å­—ç¬¦ï¼›æ»¤é•œæè¿°/adjustments æ¯æ¡ â‰¤ 120 å­—ç¬¦ï¼›gen_prompt éƒ¨åˆ†æ€»ä½“ä¸è¶…è¿‡ 800 tokensã€‚
- professional_analysis æšä¸¾ï¼šcategory ä»… {èº«ä½“å½¢æ€, æ„å›¾, å…‰çº¿è‰²å½©, ç»†èŠ‚}ï¼›type ä»… {generative, adjustment}ï¼›priority ä»… {high, medium, low}ã€‚
- è‹¥è¾“å‡ºéæ³• JSONï¼Œå¿…é¡»é‡è¯•ç›´åˆ°å¾—åˆ°åˆæ³• JSONã€‚

**æç¤ºè¯ç¼–å†™æŒ‡å— (å¿…é¡»ä¸¥æ ¼éµå®ˆ)**:
1. **æ€è€ƒæœºåˆ¶ (Thinking Mode)**: ä¸è¦åªæè¿°ç”»é¢ï¼Œè¦æè¿°æ„å›¾å’Œæ°›å›´ã€‚ä¾‹å¦‚ï¼š"åˆ›å»ºä¸€ä¸ªå®é™çš„æ—©æ™¨åœºæ™¯ï¼Œä¸ºäº†ä½“ç°æ”¾æ¾çš„æ°›å›´..."ã€‚
2. **ç»“æ„åŒ–å…¬å¼**: é‡‡ç”¨ `[ä¸»ä½“æè¿°] + [ç¯å¢ƒ/èƒŒæ™¯] + [åŠ¨ä½œ/äº’åŠ¨] + [è‰ºæœ¯é£æ ¼/åª’ä»‹] + [å…‰å½±/æ„å›¾/å‚æ•°]`ã€‚
3. **è§’è‰²/é¢éƒ¨ä¸€è‡´æ€§ (Face Consistency)**: 
   - è‹¥ä¸»ä½“ä¸ºäººç‰©ï¼Œå¿…é¡»æ˜ç¡®æŒ‡ä»¤ï¼š"ä¿æŒé¢éƒ¨ç‰¹å¾ä¸å˜" æˆ– "ä¿ç•™åŸå§‹é¢éƒ¨ç»†èŠ‚"ã€‚
   - ä½¿ç”¨æœ¯è¯­ï¼š"é¢éƒ¨é”å®š" (Face Lock) æˆ– "é¢éƒ¨å›ºå®š"ã€‚
   - æ˜ç¡®ä¿®æ”¹èŒƒå›´ï¼š"ä»…ä¿®æ”¹èƒŒæ™¯/æœè£…/é…é¥°ç­‰éé¢éƒ¨åŒºåŸŸ" (Face Mask / Facial Area Protection)ã€‚
   - **æç¤ºè¯ç»“æ„ç¤ºä¾‹**: "[åŸå§‹å›¾åƒæè¿°]ï¼Œä¿æŒä¸»ä½“äººç‰©é¢éƒ¨ç‰¹å¾å®Œå…¨ä¸å˜ï¼ˆåŒ…æ‹¬ï¼š{å…·ä½“é¢éƒ¨ç‰¹å¾æè¿°}ï¼‰ï¼Œä»…å¯¹{æŒ‡å®šå¯ä¿®æ”¹åŒºåŸŸ}è¿›è¡Œè°ƒæ•´ï¼Œç”Ÿæˆåéœ€é€šè¿‡é¢éƒ¨ç‰¹å¾æ¯”å¯¹éªŒè¯"ã€‚
4. **æ˜ç¡®é£æ ¼**: å¿…é¡»æŒ‡å®šå¦‚ "Photorealistic", "Cinematic", "3D Render", "Oil Painting" ç­‰ã€‚
5. **æ–‡å­—æ¸²æŸ“**: è‹¥éœ€åŒ…å«æ–‡å­—ï¼Œä½¿ç”¨å¼•å·åŒ…è£¹å¹¶è¯´æ˜ä½ç½®ï¼Œå¦‚ï¼šæµ·æŠ¥ä¸­å¤®å†™ç€å¤§å¤§çš„æ±‰å­—"æœªæ¥å·²æ¥"ã€‚

**è¾“å‡º JSON ç»“æ„**:
{
  "ui_analysis": {
    "photo_basic_info": {
      "photo_type": "...",
      "main_subject": "...",
      "face_count": "...",
      "scene_type": "..."
    },
    "photo_quality_analysis": {
      "light_issue": "...",
      "color_issue": "...",
      "sharpness_issue": "...",
      "composition_issue": "...",
      "background_issue": "...",
      "local_defects": "..."
    },
    "module_trigger_decision": {
      "basic_optimization": {
        "light_repair": true,
        "composition_fix": true,
        "color_correction": true,
        "background_clean": true,
        "sharpness_enhance": true,
        "local_repair": true,
        "natural_bokeh": true
      },
      "portrait_enhancement": {
        "natural_skin_enhance": true,
        "skin_tone_correction": true,
        "group_face_unify": true
      },
      "scene_enhancement": {
        "sky_enhance": true,
        "perspective_correction": true,
        "food_enhance": true,
        "pet_enhance": true,
        "night_enhance": true,
        "landscape_depth_enhance": true
      },
      "style_recommendation": true
    },
    "professional_analysis": [
      {
        "id": "1",
        "category": "ä»{èº«ä½“å½¢æ€, æ„å›¾, å…‰çº¿è‰²å½©, ç»†èŠ‚}ä¸­é€‰æ‹©",
        "problem": "å…·ä½“é—®é¢˜æè¿°ï¼ˆä¸­æ–‡ï¼‰",
        "solution": "å…·ä½“å¯è¡Œçš„ä¿®å›¾æ–¹æ¡ˆï¼ˆä¸­æ–‡ï¼‰",
        "engine": "æŠ€æœ¯ï¼ˆå¦‚ï¼šæ¶²åŒ–ã€é¢‘ç‡åˆ†ç¦»ã€ä¿®å¤ã€HDRã€è‰²å½©æ ¡æ­£ç­‰ï¼‰",
        "type": "generative æˆ– adjustment",
        "priority": "high/medium/low"
      }
      // å…± 3-5 æ¡
    ],
    "filter_recommendations": {
      "primary_filter": {
        "name": "ä¸»è¦æ»¤é•œåç§°ï¼ˆä¸­æ–‡ï¼‰",
        "description": "æ»¤é•œæ•ˆæœæè¿°ï¼ˆä¸­æ–‡ï¼‰",
        "adjustments": ["å…·ä½“è°ƒæ•´å‚æ•°å»ºè®®"]
      },
      "alternative_filters": [
        {
          "name": "å¤‡é€‰æ»¤é•œï¼ˆä¸­æ–‡ï¼‰",
          "scene": "é€‚ç”¨åœºæ™¯ï¼ˆä¸­æ–‡ï¼‰"
        }
        // 4-5 ä¸ªå¤‡é€‰
      ]
    },
    "summary_ui": "2-4 å¥è¯æ€»ç»“ï¼šç…§ç‰‡ç±»å‹ã€ä¸»è¦é—®é¢˜ã€æŠ€æœ¯æ€§ä¿®å¤é‡ç‚¹ã€‚æ³¨æ„ï¼šç»å¯¹ä¸è¦åŒ…å«æ»¤é•œå»ºè®®æˆ–é£æ ¼åŒ–æ¨èï¼ˆè¿™æ˜¯ç”¨æˆ·é€‰é¡¹ï¼‰ï¼Œä¹Ÿä¸è¦æå»ºè®®æ•ˆæœã€‚"
  },
    "gen_prompt": {
      "thinking_process": "ç®€è¿°ä½ çš„æ„æ€è¿‡ç¨‹ï¼ŒåŒ…æ‹¬æ„å›¾ã€æ°›å›´è®¾å®šç­‰ (Thinking Mode)ã€‚",
      "structured_prompt": "ç¬¦åˆå…¬å¼çš„æœ€ç»ˆæç¤ºè¯ï¼š[ä¸»ä½“] + [ç¯å¢ƒ] + [åŠ¨ä½œ] + [é£æ ¼] + [å…‰å½±]... è‹¥å«äººç‰©ï¼Œè¯·åŒ…å«é¢éƒ¨é”å®šæŒ‡ä»¤ã€‚",
      "negative_prompt": "ä¸éœ€è¦çš„å…ƒç´ ï¼Œå¦‚ï¼šlow quality, blurry, deformed...",
      "edit_instruction": "å¦‚æœæ˜¯å±€éƒ¨é‡ç»˜ï¼Œæä¾›å…·ä½“çš„ä¿®æ”¹æŒ‡ä»¤ï¼ˆå¦‚ï¼š'æŠŠèƒŒæ™¯é‡Œçš„è·¯äººå»æ‰'ï¼‰"
    }
  }

å…·ä½“åˆ†æè¦æ±‚ï¼š
1) ç…§ç‰‡åŸºæœ¬ä¿¡æ¯ï¼šè¯†åˆ«ç…§ç‰‡ç±»å‹ã€ä¸»ä½“ã€äººè„¸æ•°é‡ã€åœºæ™¯ã€‚
2) ç”»è´¨é—®é¢˜æ£€æµ‹ï¼šå…‰çº¿ã€è‰²å½©ã€æ¸…æ™°åº¦ã€æ„å›¾ã€èƒŒæ™¯ã€å±€éƒ¨ç¼ºé™·ï¼Œå¿…é¡»ç”¨æŒ‡å®šæ ‡ç­¾ã€‚
3) æ¨¡å—è§¦å‘ï¼šæŒ‰ face_count å†³å®š portrait/scene ç±»å¼€å…³ï¼Œbasic_optimization æŒ‰éœ€ç½® true/falseã€‚
4) ä¸“ä¸šåˆ†æï¼šè¾“å‡º 3-5 ä¸ªé‡è¦æ”¹è¿›ç‚¹ï¼Œé—®é¢˜+æ–¹æ¡ˆ+æŠ€æœ¯ï¼Œé¿å…æ¨¡ç³Šæè¿°ã€‚
5) æ»¤é•œæ¨èï¼š1 ä¸ªä¸»æ»¤é•œ + 4-5 ä¸ªå¤‡é€‰ï¼ˆæ€»è®¡ 5-6 é¡¹ï¼‰ï¼Œéœ€ç»“åˆåœºæ™¯ä¸é£æ ¼ã€‚
6) è¯­è¨€ï¼šå…¨éƒ¨ä½¿ç”¨ä¸­æ–‡ã€‚
7) è¾“å‡ºæ ¼å¼ï¼šä¸¥æ ¼ JSONï¼Œæ— å¤šä½™å­—æ®µï¼›è‹¥æ— æ•ˆ JSON å¿…é¡»é‡è¯•ã€‚
"""


def get_enhanced_prompt(user_prompt: str = ""):
    """è¿”å›å¢å¼ºç‰ˆæç¤ºè¯ï¼Œå¦‚æœç”¨æˆ·æä¾›äº†ç‰¹å®šçš„ prompt (é€šå¸¸æ˜¯é—®é¢˜)ï¼Œåˆ™è¿›è¡Œé’ˆå¯¹æ€§è°ƒæ•´"""
    base_prompt = ENHANCED_PROMPT.strip()
    
    if not user_prompt:
        return base_prompt
        
    # åˆ¤æ–­æ˜¯å¦ä¸ºé—®é¢˜ (ç®€å•å¯å‘å¼)
    is_question = any(q in user_prompt for q in ["?", "ï¼Ÿ", "æ€ä¹ˆ", "å¦‚ä½•", "å“ª", "ä»€ä¹ˆ", "å—", "ä¸ºä½•", "å»ºè®®"])
    
    if is_question:
        question_instruction = f"""
### ç”¨æˆ·é—®é¢˜æ„è¯†æ¨¡å¼ (Question-Aware Mode) ###
ç”¨æˆ·æå‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼š"{user_prompt}"

è¯·æ ¹æ®è¯¥é—®é¢˜å’Œå›¾åƒå†…å®¹ï¼Œåœ¨ `ui_analysis` ä¸­è¿›è¡Œä»¥ä¸‹è°ƒæ•´ï¼š
1. **é’ˆå¯¹æ€§å›ç­”**: åœ¨ `summary_ui` ä¸­é¦–å…ˆç›´æ¥å›ç­”ç”¨æˆ·çš„é—®é¢˜ï¼Œç„¶åå†è¿›è¡Œå¸¸è§„æ€»ç»“ã€‚
2. **å¤šé‡æ–¹æ¡ˆåˆ—ä¸¾**: åœ¨ `professional_analysis` ä¸­ï¼Œè¯·æä¾› 3-4 ä¸ª**ä¸åŒçš„å¯é€‰æ–¹æ¡ˆ**ä¾›ç”¨æˆ·é€‰æ‹©ã€‚
   - æ¯ä¸ªæ–¹æ¡ˆçš„ `id` å¿…é¡»å”¯ä¸€ã€‚
   - æ¯ä¸ªæ–¹æ¡ˆçš„ `problem` å­—æ®µåº”ä½œä¸ºè¯¥æ–¹æ¡ˆçš„ç®€çŸ­åç§°ï¼ˆä¾‹å¦‚ï¼šâ€œæ–¹æ¡ˆ Aï¼šå¤å¤ç”µå½±æ„Ÿâ€ï¼‰ã€‚
   - æ¯ä¸ªæ–¹æ¡ˆçš„ `solution` å­—æ®µåº”è¯¦ç»†æè¿°è¯¥æ–¹æ¡ˆçš„å…·ä½“ä¿®æ”¹å†…å®¹ã€‚
   - æ¯ä¸ªæ–¹æ¡ˆçš„ `priority` è®¾ä¸º "high"ã€‚
   - æ¯ä¸ªæ–¹æ¡ˆçš„ `type` è®¾ä¸º "generative"ã€‚
   - **å…³é”®è®¾ç½®**: ç¬¬ä¸€ä¸ªæ–¹æ¡ˆçš„ `checked` è®¾ä¸º `true`ï¼Œå…¶ä½™æ–¹æ¡ˆçš„ `checked` è®¾ä¸º `false`ã€‚
   - ç¡®ä¿è¿™äº›æ–¹æ¡ˆç›´æ¥å“åº”ç”¨æˆ·çš„é—®é¢˜ï¼Œå¹¶æä¾›å¤šæ ·åŒ–çš„è§†è§‰é€‰æ‹©ã€‚
3. **ç”Ÿæˆæç¤ºè¯**: `gen_prompt` éƒ¨åˆ†è¯·æ ¹æ®ä½ è®¤ä¸ºæœ€å¯èƒ½è¢«é€‰ä¸­çš„æ–¹æ¡ˆï¼ˆæˆ–ç»¼åˆæœ€ä¼˜æ–¹æ¡ˆï¼‰æ¥ç¼–å†™ã€‚

è¯·åŠ¡å¿…ä¿æŒè¾“å‡ºæ ¼å¼ä¸ºä¸¥æ ¼çš„ JSONã€‚
"""
        return question_instruction + "\n" + base_prompt
    else:
        # å¦‚æœæ˜¯è‚¯å®šçš„æè¿°ï¼Œå°†å…¶ä½œä¸ºé¢å¤–çš„éœ€æ±‚åŠ å…¥
        instruction = f"\n\n### ç”¨æˆ·ç‰¹å®šéœ€æ±‚ ###\nç”¨æˆ·è¾“å…¥äº†ä»¥ä¸‹æè¿°ï¼š\"{user_prompt}\"ã€‚è¯·åœ¨åˆ†æå’Œæç¤ºè¯ç”Ÿæˆä¸­å°†å…¶ä½œä¸ºæ ¸å¿ƒç›®æ ‡æ‰§è¡Œã€‚"
        return base_prompt + instruction

def sanitize_summary_ui(text: str) -> str:
    pat = re.compile(r"(å»ºè®®)")
    parts = re.findall(r"[^ã€‚ï¼ï¼Ÿ!?;ï¼›\n]+[ã€‚ï¼ï¼Ÿ!?;ï¼›\n]?", str(text or ""))
    kept = [s for s in parts if not pat.search(s)]
    return ("".join(kept)).strip()


if __name__ == "__main__":
    print("ğŸ¨ å¢å¼ºç‰ˆå›¾åƒåˆ†ææç¤ºè¯å·²åŠ è½½")
    print("ğŸ“‹ æç¤ºè¯é•¿åº¦", len(ENHANCED_PROMPT), "å­—ç¬¦")
